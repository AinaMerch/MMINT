[comment encoding = UTF-8 /]
[module StateMachineMAVOToSMTLIB_M2T('http://www.eclipse.org/emf/2002/Ecore', 'http://se.cs.toronto.edu/MAVO', 'http://se.cs.toronto.edu/modelepedia/StateMachine_MAVO')/]
[import edu::toronto::cs::se::modelepedia::z3::mavo::EcoreMAVOToSMTLIBUtils_M2T /]

[template private encodeAnalysis(sm : StateMachine)]
[';Macros'/]
(define-fun reachable1 ((s Int) (t Int)) Bool
	(and
		(node s) (node t) (= (nodeType s) STATE) (= (nodeType t) STATE)
		(exists ((s2t Int)) (and
			(edge s2t)
			(= (edgeType s2t) TRANSITION)
			(= (src s2t) s)
			(= (tgt s2t) t)
		))
	)
)
	[for (c : Integer | Sequence{2..sm.states->size()-1})]
(define-fun reachable[c/] ((s Int) (t Int)) Bool
	(and
		(node s) (node t) (= (nodeType s) STATE) (= (nodeType t) STATE)
		(exists ((x Int)) (and
			(node x)
			(= (nodeType x) STATE)
			(reachable1 s x)
			(reachable[c-1/] x t)
		))
	)
)
	[/for]
(define-fun reachable ((s Int) (t Int)) Bool
	(and
		(node s) (node t) (= (nodeType s) STATE) (= (nodeType t) STATE)
		(or
	[for (c : Integer | Sequence{1..sm.states->size()-1})]
			(reachable[c/] s t)
	[/for]
		)
	)
)
[';End Macros'/]
[/template]

[template public encodeStateMachineMAVO(sm : StateMachine, modelName : String, mayOnly : Boolean)]
	[comment @main/]
	[file (modelName + '.smt2', false, 'UTF-8')]
		[if (mayOnly)]
[encodeModelMayOnly(sm)/]
[encodeMAVOConstraintsMayOnly(sm)/]
[encodeAnalysis(sm)/]
		[else]
[encodeModel(sm)/]
[encodeMAVOConstraints(sm)/]
		[/if]
	[/file]
[/template]
